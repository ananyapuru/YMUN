"use strict";function init(){loadSortable(),$(".side-item").on("click",(function(){let goto;loadPage($(this).data("goto"))})),$("#date").html((new Date).toLocaleDateString().split("T")[0]),$("#addDelegation").on("click",(function(){let name=$("#delegation-name").val(),flag=$("#delegation-flag").val();0==name.length&&alert("Add a name please!"),0==flag.length&&alert("Add a flag please!"),name.length>0&&flag.length>0&&$.post("",{p:"add-delegation",action:!0,name:name,flag:flag},(function(result){"SUCCESS"==result?loadDPage("Delegations",!0):alert(result)}))})),$(document).on("keydown",disableF5),$("#sidebar").on("click",(function(event){event.stopPropagation()})),$("#toggleSidebar").on("click",(function(e){toggleSidebar()})),$(document).on("click",(function(e){window.toggledSidebar&&toggleSidebar(1)}))}function initResets(){$("#resetRound").on("click",(function(){let c;confirm("Are you sure to reset the current round ?")&&($("#delegations").html(window.delegations),1==window.round&&resetAll(),2==window.round&&(window.rollCall[1]={voted:[],passed:[],y:[],yr:[],n:[],nr:[],p:[],a:[]},resetVoteList(),$(".roundsum.round-2").html(""),initRound2(1),window.rollCall[0].voted.forEach(item=>{$(`#v${item}`).remove()})),3==window.round&&(window.rollCall[2]={voted:[],passed:[],y:[],yr:[],n:[],nr:[],p:[],a:[]},resetVoteList(),$(".roundsum.round-3").html(""),initRound3(1)))}))}function initCheck(){$(".vcheck").click((function(){let id=$(this).data("id"),vid=`voting-${id}`,pid=`present-${id}`,vchecked=$(`#${vid}`).is(":checked");$(`#${vid}`).is(":checked")?($(`#${pid}`).prop("checked",!0),vchecked=!1):($(`#${pid}`).prop("checked",!0),vchecked=!0),check(id,$(`#${pid}`).is(":checked"),vchecked)})),$(".pcheck").click((function(){let id=$(this).data("id"),vid=`voting-${id}`,pid=`present-${id}`,pchecked=$(`#${pid}`).is(":checked");$(`#${pid}`).is(":checked")?($(`#${vid}`).prop("checked",!1),pchecked=!1):($(`#${vid}`).prop("checked",!1),pchecked=!0),check(id,pchecked,$(`#${vid}`).is(":checked"))}))}function initAfterFlagsLoad(){$(".s-flag").on("click",(function(){$("#selectFlagBtn").html("<img src='"+$(this).data("flag")+"' height='50px' />"),$("#delegation-flag").val($(this).data("flag")),$("#select-flag").modal("toggle")}))}function disableF5(e){116==(e.which||e.keyCode)&&e.preventDefault()}function loadDPage(e,str=!1){$("#loading").fadeIn(100);let page=$(e).data("goto");str&&(page=e),$.post("",{p:"D-"+page},(function(s){$("#dashboardPage").html(s),$("#loading").fadeOut(200)}))}function loadPage(page,call=!1){$("#loading").fadeIn(100),$.post("",{p:page},(function(s){setTitle(page),$("#content").html(s),initCheck(),resetVote(),!1!==call&&call(),$("#loading").fadeOut(200)}))}function setTitle(p){p=p.toLowerCase(),$.post("",{p:"title",f:p,action:!0},(function(r){$("#page-title").html(r),$("title").html(r)}))}function toggleSidebar(force=!1){let width=$("#sidebar").outerWidth(),angle=window.toggledSidebar?"90":"0";$("#sidebar").css({transform:"rotateY("+angle+"deg)"},1e3),$("body").animate({right:width*!window.toggledSidebar},300,(function(){window.toggledSidebar=!window.toggledSidebar,force&&(window.toggledSidebar=!1)}))}function search(e){let v=$(e).val(),delegations;$("#delegationsSelectList > #results").html(""),$.post("",{p:"search-delegation",action:!0,v:v},(function(result){delegations=JSON.parse(result);let elem="";delegations.forEach(delegation=>{elem=`<div class='delegation'>\n              <img src='${delegation.flag}' />\n              <span>${delegation.name}</span>\n              <i class='fa fa-plus-square' onclick='addToSpeaking("${delegation.id}")'></i>\n            </div>`,$("#delegationsSelectList > #results").append(elem)})}))}function Login(){let username=$("#username").val(),password=$("#password").val();$.post("",{p:"Login",action:!0,username:username,password:password},(function(result){"SUCCESS"==result?loadPage("Dashboard",loadDPage("Delegations",!0)):alert("ERROR")}))}function loadFlags(l=30,f=0){$.post("",{p:"flags",action:!0,limit:l,from:f},(function(result){$("#flags").html(result),initAfterFlagsLoad()}))}function check(id,p,v){$.post("",{p:"roll-call",action:!0,id:id,present:p,voting:v},(function(e){}))}function saveCommittee(){let name=$("#committee-name").val(),stime=$("#default-speaking-time").val(),ttime=$("#default-total-time").val();$.post("",{action:!0,p:"save",name:name,s:stime,t:ttime},(function(res){let result=JSON.parse(res);"SUCCESS"==result.status?($("#committee_Name").html(result.name),loadPage("Dashboard"),loadDPage("Committee",!0)):alert(result.errorCode)}))}function saveCredentials(){let password=$("#admin-password").val(),newpassword=$("#admin-newpassword").val();$.post("",{action:!0,p:"save-cred",password:password,newpassword:newpassword},(function(res){let result=JSON.parse(res);"SUCCESS"==result.status?(loadPage("Dashboard"),loadDPage("Credentials",!0)):alert(result.errorCode)}))}function addUser(){let password=$("#user-password").val(),username=$("#user-username").val();$.post("",{action:!0,p:"save-user",password:password,username:username},(function(res){let result=JSON.parse(res);"SUCCESS"==result.status?(alert("Added!"),loadPage("Dashboard"),loadDPage("Credentials",!0)):alert(result.errorCode)}))}function deleteDelegation(e){let id=$(e).data("id"),co;confirm("Are you sure?")&&$.post("",{action:!0,id:id,p:"delete"},(function(res){"SUCCESS"==res?loadDPage("Delegations",!0):alert(res)})),saveList(),getList()}function addToSpeaking(id){if(window.yielding){let c;if(confirm("Are you sure to yield?")){window.yielding=!1;let List=JSON.parse(getList(!0));List[0]=id,updateList(List)}$("#results .delegation").removeClass("yielding"),$("#results .delegation > i").removeClass(" fa-arrow-right").addClass(" fa-plus-square"),window.yielding=!1,window.yielded=window.timer.getTimeValues().seconds}else window.elemsCount++,$.post("",{action:!0,id:id,p:"delegation"},(function(res){let result=JSON.parse(res);if("error"==result.status);else{let eId,elem=`<div id="${window.elemsCount+"-"+id}" class='speaking' data-id="${id}">\n                    <div class="img"><img src="${result.flag}"  /></div>\n                    <span>${result.name}</span>\n                    <span><i onclick="$(this).parent().parent().remove(); updateTimer()" class="fa fa-trash-o delete"></i></span>\n                </div>`;$("#speakingList").append(elem)}updateLastSpeaker(),loadSortable()}))}function loadSortable(){$("#speakingList").sortable({placeholder:"speaking-placeholder",update:function(){updateTimer(),updateLastSpeaker()}}),$("#speakingList").disableSelection(),saveList(),getList()}function saveList(){window.localStorage.setItem("speakersListLast",getList(1))}function getList(c=!1){var i=0,List=[];if($(".speaking").each((function(item){List[i]=$(this).data("id"),i++})),window.localStorage.setItem("speakersList",JSON.stringify(List)),c)return window.localStorage.getItem("speakersList")}function updateLastSpeaker(){let speakers,speaking=JSON.parse(getList(!0))[0];$.post("",{action:!0,id:speaking,p:"delegation"},(function(res){let result=JSON.parse(res);"error"==result.status||($("#speakerName").text(result.name),$("#speakerFlag").html(`<img src="${result.flag}" />`))}))}function toSeconds(number){let r=[],sNumber=number.toString(),len,s=0;for(let i=sNumber.length-1;i>=0;i-=2)r.push(Number((sNumber[i-1]?sNumber[i-1]:"")+(sNumber[i]?sNumber[i]:"")));for(let i=0;i<r.length;i++)s+=r[i]*60**i;return s}function start(ignore=!1){var to=Number($("#timerTo").val());if(window.timerStarted||(0==JSON.parse(getList(!0)).length?($("#speakerName").text("Please, select speakers from the list on the left"),$("#speakerFlag").html("")):(window.timerStarted=!0,updateLastSpeaker(),window.targetAchieved&&pregressReset(),window.timer.start({precision:"seconds",startValues:{seconds:0},target:{seconds:toSeconds(to)}}))),("m"==window.c||"u"==window.c)&&!ignore){var toTotal=Number($("#timerTotal").val());window.timerStartedTotal||(JSON.parse(getList(!0)).length>0||"u"==window.c)&&(window.timerStartedTotal=!0,window.targetAchievedTotal&&pregressResetTotal(),window.timerTotal.start({precision:"seconds",startValues:{seconds:0},target:{seconds:toSeconds(toTotal)}}))}}function updateTimer(){start(!0),reset()}function updateTimerTotal(){start(),reset()}function pause(p=!1){window.timerStarted&&!p&&(window.timer.pause(),window.timerPaused=!0,window.timerStarted=!1),window.timerStartedTotal&&(window.timerTotal.pause(),window.timerPausedTotal=!0,window.timerStartedTotal=!1)}function reset(){pause(),window.yielded=0,window.timer.reset(),window.timer.stop(),pregressReset()}function resetTotal(){pause(),window.timerTotal.reset(),window.timerTotal.stop(),pregressResetTotal()}function _yield(){window.yielding=!0,JSON.parse(getList(!0)).length>0&&(window.yielded=window.yielded<0?0:window.yielded,pause(),$("#results .delegation").addClass("yielding"),$("#results .delegation > i").removeClass(" fa-plus-square").addClass(" fa-arrow-right"),window.timerStarted=!1,window.timerStartedTotal=!1)}function updateList(List){window.localStorage.setItem("speakersList",JSON.stringify(List)),$("#speakingList").html(""),List.forEach((function(item){addToSpeaking(item)})),0==List.length&&($("#speakingList").html(""),$("#speakerName").text(""),$("#speakerFlag").html(""))}function next(){let List;if(JSON.parse(getList(!0)).length>1){window.yielded=0,window.timerPaused=!1,window.timerStarted=!1,window.targetAchieved=!1;let List=JSON.parse(getList(!0)),popped=List.shift();reset(),updateList(List),getList()}}function formatT(t){return new Date(1e3*t).toISOString().substr(14,5)}function progressing(s,to){window.timer.addEventListener("targetAchieved",progressComplete);let W=$("#progressContainer").innerWidth(),w=Number(W)*(s/to),Z=formatT(60*window.timer.getTimeValues().minutes+window.timer.getTimeValues().seconds),T=formatT(toSeconds(to));s>0&&$("#progress").removeClass("progress-halftime progress-threeq").addClass("progress progress-bar-animated ").css("width",`${w}px`),s>=to/2&&$("#progress").addClass("progress-halftime "),s>=4*to/5&&$("#progress").addClass("progress-threeq "),$("#progressLabel").text(`${Z}/${T}`)}function progressComplete(){$("#progress").removeClass("progress progress-halftime progress-threeq progress-bar-animated ").addClass("progress-complete"),window.targetAchieved=!0,window.timerStarted=!1,window.timerPaused=!1,pause(!0)}function pregressReset(){window.targetAchieved=!1,window.timerStarted=!1,$("#progressLabel").text("00:00"),$("#progress").css("width","0").removeClass("progress-complete").addClass("progress progress-bar-animated ")}function progressingTotal(s,to){window.timer.addEventListener("targetAchievedTotal",progressCompleteTotal);let W=$("#progressContainerTotal").innerWidth(),w=Number(W)*(s/to),Z=formatT(60*window.timerTotal.getTimeValues().minutes+window.timerTotal.getTimeValues().seconds),T=formatT(toSeconds(to));s>0&&$("#progressTotal").removeClass("progress-halftime progress-threeq").addClass("progress progress-bar-animated ").css("width",`${w}px`),s>=to/2&&$("#progressTotal").addClass("progress-halftime "),s>=4*to/5&&$("#progressTotal").addClass("progress-threeq "),$("#progressLabelTotal").text(`${Z}/${T}`)}function progressCompleteTotal(){$("#progressTotal").removeClass("progress progress-halftime progress-threeq progress-bar-animated ").addClass("progress-complete"),window.targetAchievedTotal=!0,window.timerStartedTotal=!1,window.timerPausedTotal=!1}function pregressResetTotal(){window.targetAchievedTotal=!1,window.timerStartedTotal=!1,$("#progressLabelTotal").text("00:00"),$("#progressTotal").css("width","0").removeClass("progress-complete").addClass("progress progress-bar-animated ")}function updateStats(tid=null){let speaker=null;"u"!==window.c&&(speaker=JSON.parse(getList(!0))[0]),$.post("",{p:"update-stat",id:speaker,t:window.c,tid:tid,action:!0},(function(e){}))}function demandTopic(){let topic="";for(;!topic&&(topic=prompt("Please, type the topic before starting"),$.post("",{p:"new-topic",action:!0,t:topic},(function(e){getTopic()})),"null"!=topic&&null!=topic&&""!=topic););}function getTopic(d=!1){$.post("",{p:"get-session",action:!0},(function(e){let r=JSON.parse(e);window.moderatedTopic=r.topic_id,d?$("#session").val(r.topic):$("#topic").html(r.topic)}))}function getVoteSession(){$.post("",{p:"get-vote-session",action:!0},(function(e){let r=JSON.parse(e);window.voteSession=r.session_id}))}$(document).ready((function(){init(),$("#uploader").on("change",(function(){var formData=new FormData;formData.append("file",$("input[type=file]")[0].files[0]),formData.append("p","upload"),formData.append("action",!0),$.ajax({url:"",type:"POST",data:formData,success:function(data){"ERROR"==data?alert("Error!"):($("#selectFlagBtn").html("<img src='"+data+"' height='50px' />"),$("#delegation-flag").val(data))},cache:!1,contentType:!1,processData:!1})}))})),window.toggledSidebar=!1,window.yielding=!1,window.elemsCount=0,window.yielded=0,window.timerStarted=!1,window.timerPaused=!1,window.targetAchieved=!1,window.timer=new easytimer.Timer,window.timerStartedTotal=!1,window.timerPausedTotal=!1,window.targetAchievedTotal=!1,window.timerTotal=new easytimer.Timer,window.timer.addEventListener("secondsUpdated",(function(e){let to=Number($("#timerTo").val());$("#progressLabel").html(window.timer.getTimeValues().toString());let S=window.timer.getTimeValues().seconds;S+=60*window.timer.getTimeValues().minutes,updateStats(window.moderatedTopic),progressing(S,to)})),window.timerTotal.addEventListener("secondsUpdated",(function(e){let toTotal=Number($("#timerTotal").val());$("#progressLabelTotal").html(window.timer.getTimeValues().toString());let S=window.timerTotal.getTimeValues().seconds;S+=60*window.timerTotal.getTimeValues().minutes,progressingTotal(S,toTotal),"u"==window.c&&updateStats(window.moderatedTopic)}));var Lang={p:"This delegation passed to vote on second round",y:"This delegation voted in favour",n:"This delegation voted against",yr:"This delegation voted in favour with rights",nr:"This delegation voted against with rights",a:"This delegation abstained"},Labels={p:"Passed",y:"In favour",n:"Against",yr:"In favour with rights",nr:"Against with rights",a:"Abstained"};function resetVote(r=!1){window.rollCall[0]={voted:[],passed:[],y:[],yr:[],n:[],nr:[],p:[],a:[]},window.rollCall[1]={voted:[],passed:[],y:[],yr:[],n:[],nr:[],p:[],a:[]},window.rollCall[2]={voted:[],passed:[],y:[],yr:[],n:[],nr:[],p:[],a:[]},window.round=1,r?$("#delegations").html(window.delegations):window.delegations=$("#delegations").html(),window.finalRoundAccess=!1}function vote(t,by,v=!1){if(window.rollCall[window.round-1].voted.includes(by))alert(Lang[window.rollCall[window.round-1][by]]);else if(v&&"a"==t)alert("This delegation cannot abstain (It is set as a voting member on the presence list).");else if($(`#v${by}`).fadeOut(100),"p"!==t?(window.rollCall[window.round-1].voted.push(by),1==window.round&&(window.rollCall[1].voted.push(by),window.rollCall[1][by]=t,window.rollCall[1][t]++),$(`#v${by}`).remove()):window.rollCall[window.round-1].passed.push(by),updateVoteList(by,window.round-1),window.rollCall[window.round-1][by]=t,window.rollCall[window.round-1][t]++,1==window.round&&window.rollCall[0].voted.length+window.rollCall[0].passed.length>=window.number&&(window.round=2),2==window.round&&(initRound2(),(window.rollCall[1].voted.length-window.rollCall[0].voted.length==window.rollCall[0].passed.length||window.rollCall[0].voted.length>=window.number)&&(window.round=3)),3==window.round&&(initRound3(),window.rollCall[2].voted.length>=window.number&&(window.round=4),window.finalRoundAccess||($("#delegations").html(window.delegations),$("#round").text("Round 3"),$(".third").hide()),window.finalRoundAccess++),4==window.round){window.rollCall[2].voted.forEach(item=>{$(`#Rv${item} .round-3`).text(window.Labels[window.rollCall[2][item]])}),$(".roundyes.round-count-1").text(0==window.rollCall[0].y.length?window.rollCall[0].y.length:window.rollCall[0].y),$(".roundyes.round-count-2").text(0==window.rollCall[1].y.length?window.rollCall[1].y.length:window.rollCall[1].y),$(".roundyes.round-count-3").text(0==window.rollCall[2].y.length?window.rollCall[2].y.length:window.rollCall[2].y),$(".roundno.round-count-1").text(0==window.rollCall[0].n.length?window.rollCall[0].n.length:window.rollCall[0].n),$(".roundno.round-count-2").text(0==window.rollCall[1].n.length?window.rollCall[1].n.length:window.rollCall[1].n),$(".roundno.round-count-3").text(0==window.rollCall[2].n.length?window.rollCall[2].n.length:window.rollCall[2].n);let c=$("#session").val();for(;!c;)c=prompt("Save vote session under the name: ");c&&($("#session").val(c),saveVoteSession(c))}}function initRound2(r=!1){window.rollCall[0].voted.forEach(item=>{r&&updateVoteList(item,0),$(`#Rv${item} .round-1`).text(window.Labels[window.rollCall[0][item]])}),window.rollCall[0].passed.forEach(item=>{r&&updateVoteList(item,0),$(`#Rv${item} .round-1`).text(window.Labels[window.rollCall[0][item]]),$(`#v${item}`).fadeIn(200)}),$("#round").text("Round 2"),$(".second").hide()}function initRound3(r=!1){window.rollCall[1].voted.forEach(item=>{r&&updateVoteList(item,1),$(`#Rv${item} .round-2`).text(window.Labels[window.rollCall[1][item]])})}function resetAll(){resetVote(1),resetVoteList(),$(".roundsum").html(""),$("#round").text("Round "+window.round)}function updateVoteList(id,round){$.ajax({type:"POST",url:"",data:{p:"delegation",id:id,action:!0},success:function(e){let delegation=JSON.parse(e),voted=window.rollCall[round][id].toUpperCase(),elem=`<div>${delegation.name}</div>`;$(` #votes${voted} .votes`).append(elem),$(` #votes${voted} .count`).html(window.rollCall[round][window.rollCall[round][id]]),3==window.round&&1==window.finalRoundAccess&&resetVoteList()}})}function resetVoteList(){$(".votes").html(""),$(".count").html("")}function saveVoteSession(c){$.post("",{action:!0,a:c,p:"save-vote-session",t:$("#voteFor").val(),data:JSON.stringify(window.rollCall[2])},(function(e){"SUCCESS"==e&&alert("Successfully added to database!")}))}function loadStats(){$(".time").each((function(i){let total=Number($(this).data("total")),time,width=Number($(this).data("time"))*Number($(this).parent().width())/total;width=width.toFixed(2),$(this).animate({width:width+"px"},50)}))}function collpase(id){window.toggledCollapse||($(`.details:not(#${id})`).slideUp(100),$(`#${id}`).slideToggle({progress:function(){window.toggledCollapse=!0},complete:function(){window.toggledCollapse=!1}}))}function resetAllStats(){let c;if(confirm("This will erase all time-related statistics of all the delegations, are you sure you want to do that?")){let b=confirm("Do you want to delete the votes history as well?");$.post("",{action:!0,p:"reset-all",all:b?"yes":"no"},(function(r){window.location.reload()}))}}function resetStatsFor(id){let c;confirm("This will erase all time-related statistics of this delegation, are you sure you want to do that?")&&$.post("",{action:!0,p:"reset-stats",id:id},(function(r){"SUCCESS"==r&&window.location.reload()}))}function initTally(){$("#getTally").on("click",(function(){let topic=$("#session").val(),date=(new Date).toLocaleDateString().split("T")[0];$("#summaryClone").html($("#summary").html()).append(`\n        <div style="margin: auto; width: 100%;" class="badge badge-pill "> \n            <strong>Topic: ${topic}</strong> | <i>Date: ${date}</i>\n        </div>`);var div=document.querySelector("#summaryClone"),rect=div.getBoundingClientRect();$("#summaryClone").fadeOut();var canvas=document.createElement("canvas");canvas.width=rect.width,canvas.height=rect.height;var ctx=canvas.getContext("2d");html2canvas(div,{scrollY:-window.scrollY,canvas:canvas}).then(canvas=>{canvas.toBlob((function(blob){saveAs(blob,"Summary.png"),$("#summaryClone").html(""),$("#summaryClone").fadeIn()}))})}))}window.rollCall=[],resetVote(),window.toggledCollapse=!1;